# coding: utf-8
class Battle

  def self.random_map
    [
      "maps/cell_maze/cell_maze_p02_04.map",
      "maps/cell_maze/cell_maze_p02_06.map",
      "maps/cell_maze/cell_maze_p02_07.map",
      "maps/cell_maze/cell_maze_p02_08.map",
      "maps/cell_maze/cell_maze_p02_09.map",
      "maps/cell_maze/cell_maze_p02_10.map",
      "maps/cell_maze/cell_maze_p02_11.map",
      "maps/cell_maze/cell_maze_p02_12.map",
      "maps/cell_maze/cell_maze_p02_13.map",
      "maps/cell_maze/cell_maze_p02_14.map",
      "maps/cell_maze/cell_maze_p02_15.map",
      "maps/cell_maze/cell_maze_p02_16.map",
      "maps/cell_maze/cell_maze_p02_17.map",
      "maps/cell_maze/cell_maze_p02_18.map",
      "maps/cell_maze/cell_maze_p02_19.map",
      "maps/cell_maze/cell_maze_p02_20.map",
      "maps/cell_maze/cell_maze_p02_21.map",
      "maps/cell_maze/cell_maze_p02_22.map",
      "maps/maze/maze_p02_01.map",
      "maps/maze/maze_p02_02.map",
      "maps/maze/maze_p02_03.map",
      "maps/maze/maze_p02_04.map",
      "maps/maze/maze_p02_05.map",
      "maps/maze/maze_p02_06.map",
      "maps/maze/maze_p02_07.map",
      "maps/maze/maze_p02_08.map",
      "maps/maze/maze_p02_09.map",
      "maps/maze/maze_p02_10.map",
      "maps/maze/maze_p02_11.map",
      "maps/maze/maze_p02_12.map",
      "maps/maze/maze_p02_13.map",
      "maps/maze/maze_p02_14.map",
      "maps/maze/maze_p02_15.map",
      "maps/maze/maze_p02_16.map",
      "maps/maze/maze_p02_17.map",
      "maps/maze/maze_p02_18.map",
      "maps/maze/maze_p02_19.map",
      "maps/maze/maze_p02_20.map",
      "maps/maze/maze_p02_21.map",
      "maps/maze/maze_p02_22.map",
      "maps/maze/maze_p02_23.map",
      "maps/maze/maze_p02_24.map",
      "maps/maze/maze_p02_25.map",
      "maps/maze/maze_p02_26.map",
      "maps/maze/maze_p02_27.map",
      "maps/maze/maze_p02_28.map",
      "maps/maze/maze_p02_29.map",
      "maps/maze/maze_p02_30.map",
      "maps/maze/maze_p02_31.map",
      "maps/maze/maze_p02_32.map",
      "maps/maze/maze_p02_33.map",
      "maps/maze/maze_p02_34.map",
      "maps/maze/maze_p02_35.map",
      "maps/maze/maze_p02_36.map",
      "maps/maze/maze_p02_37.map",
      "maps/maze/maze_p02_38.map",
      "maps/maze/maze_p02_39.map",
      "maps/maze/maze_p02_40.map",
      "maps/maze/maze_p02_41.map",
      "maps/maze/maze_p02_42.map",
      "maps/maze/maze_p02_43.map",
      "maps/random_walk/random_walk_p02_01.map",
      "maps/random_walk/random_walk_p02_02.map",
      "maps/random_walk/random_walk_p02_03.map",
      "maps/random_walk/random_walk_p02_04.map",
      "maps/random_walk/random_walk_p02_05.map",
      "maps/random_walk/random_walk_p02_06.map",
      "maps/random_walk/random_walk_p02_07.map",
      "maps/random_walk/random_walk_p02_08.map",
      "maps/random_walk/random_walk_p02_09.map",
      "maps/random_walk/random_walk_p02_10.map",
      "maps/random_walk/random_walk_p02_11.map",
      "maps/random_walk/random_walk_p02_12.map",
      "maps/random_walk/random_walk_p02_13.map",
      "maps/random_walk/random_walk_p02_14.map",
      "maps/random_walk/random_walk_p02_15.map",
      "maps/random_walk/random_walk_p02_16.map",
      "maps/random_walk/random_walk_p02_17.map",
      "maps/random_walk/random_walk_p02_18.map",
      "maps/random_walk/random_walk_p02_19.map",
      "maps/random_walk/random_walk_p02_20.map",
      "maps/random_walk/random_walk_p02_21.map",
      "maps/random_walk/random_walk_p02_22.map",
      "maps/random_walk/random_walk_p02_23.map",
      "maps/random_walk/random_walk_p02_24.map",
      "maps/random_walk/random_walk_p02_25.map",
      "maps/random_walk/random_walk_p02_26.map",
      "maps/random_walk/random_walk_p02_27.map",
      "maps/random_walk/random_walk_p02_28.map",
      "maps/random_walk/random_walk_p02_29.map",
      "maps/random_walk/random_walk_p02_30.map",
      "maps/random_walk/random_walk_p02_31.map",
      "maps/random_walk/random_walk_p02_32.map",
      "maps/random_walk/random_walk_p02_33.map",
      "maps/random_walk/random_walk_p02_34.map",
      "maps/random_walk/random_walk_p02_35.map",
      "maps/random_walk/random_walk_p02_36.map",
      "maps/random_walk/random_walk_p02_37.map",
      "maps/random_walk/random_walk_p02_38.map",
      "maps/random_walk/random_walk_p02_39.map",
      "maps/random_walk/random_walk_p02_40.map",
      "maps/random_walk/random_walk_p02_41.map",
      "maps/random_walk/random_walk_p02_42.map",
      "maps/random_walk/random_walk_p02_43.map",
      "maps/random_walk/random_walk_p02_44.map",
      "maps/random_walk/random_walk_p02_45.map",
      "maps/random_walk/random_walk_p02_46.map",
      "maps/random_walk/random_walk_p02_47.map",
      "maps/random_walk/random_walk_p02_48.map",
      "maps/random_walk/random_walk_p02_49.map",
      "maps/random_walk/random_walk_p02_50.map",
      "maps/random_walk/random_walk_p02_51.map",
      "maps/random_walk/random_walk_p02_52.map",
      "maps/random_walk/random_walk_p02_53.map",
      "maps/random_walk/random_walk_p02_54.map",
      "maps/random_walk/random_walk_p02_55.map",
      "maps/random_walk/random_walk_p02_56.map",
      "maps/random_walk/random_walk_p02_57.map",
      "maps/random_walk/random_walk_p02_58.map",
      "maps/random_walk/random_walk_p02_59.map",
      "maps/random_walk/random_walk_p02_60.map",
      "maps/random_walk/random_walk_p02_61.map",
      "maps/random_walk/random_walk_p02_62.map",
      "maps/random_walk/random_walk_p02_63.map",
      "maps/random_walk/random_walk_p02_64.map",
      "maps/random_walk/random_walk_p02_65.map",
      "maps/random_walk/random_walk_p02_66.map",
      "maps/random_walk/random_walk_p02_67.map",
      "maps/random_walk/random_walk_p02_68.map",
      "maps/random_walk/random_walk_p02_69.map",
      "maps/random_walk/random_walk_p02_70.map",
      "maps/random_walk/random_walk_p02_71.map",
      "maps/random_walk/random_walk_p02_72.map",
    ].sample
  end

  def self.fight!(bots)

    play_game_command = 'cd ' + Rails.root.to_s + '/aitools; ./playgame.py --end_wait=0.25 --nolaunch --log_stdout --log_dir game_logs --turns 1000 --map_file ' + self.random_map + ' "$@" '


    bot_paths = []

    bots.each do |bot|
      path = (clean_and_setup_temp_path slugorize(bot.player_name), bot.source.to_file.path)
      if path.present?
        bot_paths << (clean_and_setup_temp_path slugorize(bot.player_name), bot.source.to_file.path)
      else
        raise "Bot #{bot.player_name} did not have a valid path"
      end
    end

    bot_paths.map!{|p| '"ruby '+ p + '"'}

    play_game_command += bot_paths.join(" ")

    puts play_game_command
    `#{play_game_command}`
  end

  private

  # Extract bot.zip to a temp directory
  def self.clean_and_setup_temp_path(username, zip_file_path)
    return nil if username.nil? || !File.exists?(zip_file_path)

    temp_zip_path = Rails.root.join("aitools", "bots", username)

    if File.exists? temp_zip_path
      `rm -rf #{temp_zip_path}`
    end

    Dir.mkdir(temp_zip_path)

    unzip_command = "unzip #{zip_file_path} -d #{temp_zip_path}"

    `#{unzip_command}`

    bot_path = get_my_bot_rb_path temp_zip_path
  end

  def self.get_my_bot_rb_path(source_path)
    list_of_files = Dir["#{source_path}/**/**"]
    result = ""
    list_of_files.each do |file|
      if (File.basename(file) == "MyBot.rb" && (file.to_s == source_path.to_s + "/" + File.basename(file))) ||
        (File.basename(file) == "bot.rb" && (file.to_s == source_path.to_s + "/" + File.basename(file))) ||
        (File.basename(file) == "bot")
        result = file
      end
    end
    return result
  end

  def self.slugorize(string)
    result = string.downcase
    result.gsub!(/&([0-9a-z#])+;/, '')  # Ditch Entities
    result.gsub!(/['|â€™]/, '')           # Remove apostrophes
    result.gsub!('&', 'and')            # Replace & with 'and'
    result.gsub!(/[^a-z0-9\-]/, '-')    # Get rid of anything we don't like
    result.gsub!(/-+/, '-')             # collapse dashes
    result.gsub!(/-$/, '')              # trim dashes
    result.gsub!(/^-/, '')              # trim dashes
    result
  end
end
